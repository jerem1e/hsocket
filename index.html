<!DOCTYPE html>
<html lang="en">
<head>
<script src="./wsClient.js"></script>

<style type="text/css">
html {
    overflow: hidden;
}
body {
    overflow: hidden;
    padding: 0;
    margin: 0;
    width: 100%;
    height: 100%;
    background: gray;
}
#log {
    background: white;
    margin: 0;
    padding: 0.5em 0.5em 0.5em 0.5em;
    position: absolute;
    top: 0.5em;
    left: 0.5em;
    right: 0.5em;
    bottom: 3em;
    overflow: auto;
}
#form {
    padding: 0 0.5em 0 0.5em;
    margin: 0;
    position: absolute;
    bottom: 1em;
    left: 0px;
    width: 100%;
    overflow: hidden;
}
</style>
</head>
<body>
<div id="log"></div>

<form id="form">
		<button type="button" onclick="wsclient.destroy()">@click_to_destroy</button>
		<button type="button" onclick="wsclient.reconnect()">@click_to_reconnect</button>
		<button type="button" onclick="wsclient.subscribe('topic.x')">@sub_topic_x</button>

		<button type="button" onclick="postData('topic.general', 'sent ' + Date.now() )">@fire_message_general</button>
		<button type="button" onclick="postData('topic.x', 'sent x ' + Date.now() )">@fire_message_x</button>
</form>
<script>
	function postData(topic, body) {
		return fetch('http://' + document.location.host + '/ws-firer', {
			method: 'POST', // *GET, POST, PUT, DELETE, etc.
			mode: 'cors', // no-cors, *cors, same-origin
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({
				topic, body
			}) // body data type must match "Content-Type" header
		}).then(rs => rs.json())
	}
</script>
<script type="text/javascript">
		var msg = document.getElementById("msg");
		var log = document.getElementById("log");
		function appendLog(item) {
				var doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
				log.appendChild(item);
				if (doScroll) {
						log.scrollTop = log.scrollHeight - log.clientHeight;
				}
		}
		var wsclient = wsClient({
			WebSocket: window.WebSocket,
			url: "ws://" + document.location.host + "/ws"
		})

		wsclient.connect(function() {
			wsclient.subscribe('topic.general')
		})

		wsclient.onmessage = function(err, message, evt) {
			var item = document.createElement("div");
			if(err) {
				item.innerText = err
				appendLog(item);
				return
			}
			item.innerText = `"${message.topic}": ${message.body}`
			appendLog(item);
		}

	</script>
</body>
</html>